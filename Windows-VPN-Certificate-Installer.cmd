@echo off
title Tony Tunnel VPN Setup
@REM :VBSDynamicBuild
@REM SET TempVBSFile=%temp%\~tmpSendKeysTemp.vbs
@REM IF EXIST "%TempVBSFile%" DEL /F /Q "%TempVBSFile%"
@REM ECHO Set WshShell = WScript.CreateObject("WScript.Shell") >>"%TempVBSFile%"
@REM ECHO Wscript.Sleep 900                                    >>"%TempVBSFile%"
@REM ECHO WshShell.SendKeys "{F11}"                            >>"%TempVBSFile%
@REM ECHO Wscript.Sleep 900                                    >>"%TempVBSFile%"
@REM CSCRIPT //nologo "%TempVBSFile%


for /l %%i in (1, 1, 1) do (
  echo   ______                     ______                       __
  echo  /_  __/___  ____  __  __   /_  __/_  ______  ____  ___  / /
  echo   / / / __ \/ __ \/ / / /    / / / / / / __ \/ __ \/ _ \/ / 
  echo  / / / /_/ / / / / /_/ /    / / / /_/ / / / / / / /  __/ /  
  echo /_/  \____/_/ /_/\__, /    /_/  \__,_/_/ /_/_/ /_/\___/_/   
  echo                 /____/                                    
  echo Powering UP ARC Reactor [#                                      ]
  timeout /t 1 >nul
  cls
  echo   ______                     ______                       __
  echo  /_  __/___  ____  __  __   /_  __/_  ______  ____  ___  / /
  echo   / / / __ \/ __ \/ / / /    / / / / / / __ \/ __ \/ _ \/ / 
  echo  / / / /_/ / / / / /_/ /    / / / /_/ / / / / / / /  __/ /  
  echo /_/  \____/_/ /_/\__, /    /_/  \__,_/_/ /_/_/ /_/\___/_/   
  echo                 /____/                                    
  echo Powering UP ARC Reactor [######                                 ]
  timeout /t 1 >nul
  cls
  echo   ______                     ______                       __
  echo  /_  __/___  ____  __  __   /_  __/_  ______  ____  ___  / /
  echo   / / / __ \/ __ \/ / / /    / / / / / / __ \/ __ \/ _ \/ / 
  echo  / / / /_/ / / / / /_/ /    / / / /_/ / / / / / / /  __/ /  
  echo /_/  \____/_/ /_/\__, /    /_/  \__,_/_/ /_/_/ /_/\___/_/   
  echo                 /____/                                    
  echo Powering UP ARC Reactor [##############                         ] 
  timeout /t 1 >nul
  cls
  echo   ______                     ______                       __
  echo  /_  __/___  ____  __  __   /_  __/_  ______  ____  ___  / /
  echo   / / / __ \/ __ \/ / / /    / / / / / / __ \/ __ \/ _ \/ / 
  echo  / / / /_/ / / / / /_/ /    / / / /_/ / / / / / / /  __/ /  
  echo /_/  \____/_/ /_/\__, /    /_/  \__,_/_/ /_/_/ /_/\___/_/   
  echo                 /____/                                    
  echo Powering UP ARC Reactor [#####################                  ] 
  timeout /t 1 >nul
  cls
  echo   ______                     ______                       __
  echo  /_  __/___  ____  __  __   /_  __/_  ______  ____  ___  / /
  echo   / / / __ \/ __ \/ / / /    / / / / / / __ \/ __ \/ _ \/ / 
  echo  / / / /_/ / / / / /_/ /    / / / /_/ / / / / / / /  __/ /  
  echo /_/  \____/_/ /_/\__, /    /_/  \__,_/_/ /_/_/ /_/\___/_/   
  echo                 /____/                                    
  echo Powering UP ARC Reactor [#########################              ] 
  timeout /t 1 >nul
  cls
  echo   ______                     ______                       __
  echo  /_  __/___  ____  __  __   /_  __/_  ______  ____  ___  / /
  echo   / / / __ \/ __ \/ / / /    / / / / / / __ \/ __ \/ _ \/ / 
  echo  / / / /_/ / / / / /_/ /    / / / /_/ / / / / / / /  __/ /  
  echo /_/  \____/_/ /_/\__, /    /_/  \__,_/_/ /_/_/ /_/\___/_/   
  echo                 /____/                                    
  echo Powering UP ARC Reactor [################################       ] 
  timeout /t 1 >nul
  cls
  echo   ______                     ______                       __
  echo  /_  __/___  ____  __  __   /_  __/_  ______  ____  ___  / /
  echo   / / / __ \/ __ \/ / / /    / / / / / / __ \/ __ \/ _ \/ / 
  echo  / / / /_/ / / / / /_/ /    / / / /_/ / / / / / / /  __/ /  
  echo /_/  \____/_/ /_/\__, /    /_/  \__,_/_/ /_/_/ /_/\___/_/   
  echo                 /____/                                    
  echo Powering UP ARC Reactor [###################################    ] 
  timeout /t 1 >nul
  cls
  echo   ______                     ______                       __
  echo  /_  __/___  ____  __  __   /_  __/_  ______  ____  ___  / /
  echo   / / / __ \/ __ \/ / / /    / / / / / / __ \/ __ \/ _ \/ / 
  echo  / / / /_/ / / / / /_/ /    / / / /_/ / / / / / / /  __/ /  
  echo /_/  \____/_/ /_/\__, /    /_/  \__,_/_/ /_/_/ /_/\___/_/   
  echo                 /____/                                    
  echo Powering UP ARC Reactor [#######################################]
  timeout /t 1 >nul
  echo ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  echo                    Powered UP ARC Reactor !!
  echo                         Booting System
  echo                    [https://tonytunnel.xyz]
  echo ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
)
timeout /t 4 >nul
cls

echo   ______                     ______                       __
echo  /_  __/___  ____  __  __   /_  __/_  ______  ____  ___  / /
echo   / / / __ \/ __ \/ / / /    / / / / / / __ \/ __ \/ _ \/ / 
echo  / / / /_/ / / / / /_/ /    / / / /_/ / / / / / / /  __/ /  
echo /_/  \____/_/ /_/\__, /    /_/  \__,_/_/ /_/_/ /_/\___/_/   
echo                 /____/          


setlocal DisableDelayedExpansion
set "SPath=%SystemRoot%\System32"
if exist "%SystemRoot%\Sysnative\reg.exe" (set "SPath=%SystemRoot%\Sysnative")
set "Path=%SPath%;%SystemRoot%;%SPath%\Wbem;%SPath%\WindowsPowerShell\v1.0\"
set "_err====== ERROR ====="
set "_work=%~dp0"
if "%_work:~-1%"=="\" set "_work=%_work:~0,-1%"

for /f "tokens=4-5 delims=. " %%i in ('ver') do set version=%%i.%%j
if "%version%" == "10.0" goto :Check_Admin
if "%version%" == "6.3" goto :Check_Admin
if "%version%" == "6.2" goto :Check_Admin
goto :E_Win

:Check_Admin
reg query HKU\S-1-5-19 >nul 2>&1 || goto :E_Admin

where certutil >nul 2>&1
if %errorlevel% neq 0 goto :E_Cu
where powershell >nul 2>&1
if %errorlevel% neq 0 goto :E_Ps

setlocal EnableDelayedExpansion
cd /d "!_work!"


echo.
echo                                              - Powered by Tony Tunnel (https://tonytunnel.xyz)
echo                                              - Inspired by Arc Reactor
echo.                 
echo Note:
echo 1. VPN Profile "your_file.p12"
echo 2. Automatically detected [your_file]
echo 3. Just Press Enter
echo ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
echo ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

set client_name_gen=
for /F "eol=| delims=" %%f in ('dir "*.p12" /A-D /B /O-D /TW 2^>nul') do (
  set "p12_latest=%%f"
  set "client_name_gen=!p12_latest:.p12=!"
  goto :Enter_Client_Name

)

:Enter_Client_Name
echo.
echo Enter the name of your profile:
set client_name=
set p12_file=
if defined client_name_gen (
  set /p client_name="VPN client name: [%client_name_gen%] "
  if not defined client_name set "client_name=%client_name_gen%"
) else (
  set /p client_name="VPN client name: "
  if not defined client_name goto :Abort
)
set "client_name=%client_name:"=%"
set "client_name=%client_name: =%"
set "p12_file_temp=%_work%\!client_name!.p12"

if exist "!p12_file_temp!" (
  set "p12_file_new=%_work%\!client_name!.p12"
  ren "!p12_file_temp!" "!client_name!.p12"
  set "p12_file=!p12_file_new!"
) else (
  echo ERROR: File "!p12_file_temp!" not found.
  echo You must put the profile in the same folder...
  goto :Enter_Client_Name
)

if not exist "!p12_file!" (
  echo.
  echo ERROR: File "!p12_file!" not found.
  echo You must put the profile in the same folder...
  goto :Enter_Client_Name
)

:menu
echo Please select your Purchased Plan option:
echo 1. Free Plan
echo 2. Limited Plan
echo 3. Basic Plan
set /p option=Enter your choice (1, 2, or 3):

if "%option%"=="1" (
    set "server_addr=IP"
) else if "%option%"=="2" (
    set "server_addr=IP"
) else if "%option%"=="3" (
    set "server_addr=IP"
) else (
    echo Invalid option. Please select your purchased plan
    echo ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    echo ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    goto menu
)

REM echo Server address set to: %server_addr%

color 4
set "server_addr=%server_addr:"=%"
set "server_addr=%server_addr: =%"

set "conn_name_gen=IKEv2 VPN %server_addr%"
powershell -command "Get-VpnConnection -Name '%conn_name_gen%'" >nul 2>&1
if !errorlevel! neq 0 (
  goto :Enter_Conn_Name
)
set "conn_name_gen=IKEv2 VPN 2 %server_addr%"
powershell -command "Get-VpnConnection -Name '%conn_name_gen%'" >nul 2>&1
if !errorlevel! neq 0 (
  goto :Enter_Conn_Name
)
set "conn_name_gen=IKEv2 VPN 3 %server_addr%"
powershell -command "Get-VpnConnection -Name '%conn_name_gen%'" >nul 2>&1
if !errorlevel! equ 0 (
  set conn_name_gen=
)

:Enter_Conn_Name
set "conn_name=Tony Tunnel"
set "conn_name=%conn_name:"=%"
if defined conn_name_gen (
  if not defined conn_name set "conn_name=%conn_name_gen%"
) else (
  set /p conn_name="IKEv2 connection name: "
  if not defined conn_name goto :Abort
)
set "conn_name=%conn_name:"=%"
powershell -command "Get-VpnConnection -Name '%conn_name%'" >nul 2>&1
if !errorlevel! equ 0 (
  echo.
  echo ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  echo ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  echo.
  echo ERROR: Remove OLD Tony Tunnel VPN !!!
  echo.
  echo Follow The Instruction to Delete the Profile:
  echo.
  echo Search "VPN Setting" by pressing Windows
  echo Remove VPN Profile Name "Tony Tunnel"
  echo.
  echo Then Continue the installing....Try Again
  echo.
  echo ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  echo ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  pause
  goto :Enter_Conn_Name
)


certutil -f -p "" -importpfx "%p12_file%" NoExport >nul 2>&1
if !errorlevel! equ 0 goto :Create_Conn
:Import_P12
certutil -f -importpfx "%p12_file%" NoExport
if !errorlevel! neq 0 goto :Import_P12

:Create_Conn
cls
color 7
echo Contacting Server...
timeout /t 2 >nul
echo Configuring Tony Tunnel VPN...
timeout /t 2 >nul
cls

powershell -command "Add-VpnConnection -ServerAddress '%server_addr%' -Name '%conn_name%' -TunnelType IKEv2 -AuthenticationMethod MachineCertificate -EncryptionLevel Required -PassThru"
if !errorlevel! neq 0 (
  echo ERROR: Could not create the Tony Tunnel VPN. Contact for Support contact@tonytunnel.xyz
  color 4
  goto :Done
)

powershell -command "Set-VpnConnectionIPsecConfiguration -ConnectionName '%conn_name%' -AuthenticationTransformConstants GCMAES128 -CipherTransformConstants GCMAES128 -EncryptionMethod AES256 -IntegrityCheckMethod SHA256 -PfsGroup None -DHGroup Group14 -PassThru -Force"
if !errorlevel! neq 0 (
  echo Could not create the Tony Tunnel VPN. Contact for Support contact@tonytunnel.xyz
  color 4
  goto :Done
)

echo Tony Tunnel VPN Profile configuration successfully imported ^_^
echo To connect to the VPN, click on the wireless/network icon in your system tray,
echo select the "%conn_name%" VPN entry, and click Connect.
goto :Done

:E_Admin
echo %_err%
echo This script requires administrator privileges.
echo Right-click on the script and select 'Run as administrator'.
goto :Done

:E_Win
echo %_err%
echo This script requires Windows 8, 10 or 11.
echo Windows 7 users can't install. Contact for Support contact@tonytunnel.xyz
echo Or Upgrade Your Windows OS.
goto :Done

:E_Cu
echo %_err%
echo This script requires 'certutil', which is not detected. 
echo Update Your Windows.
goto :Done

:E_Ps
echo %_err%
echo This script requires 'powershell', which is not detected.
echo Update Your Windows.
goto :Done

:Abort
echo.
echo Abort. No changes were made.
echo Contact for Support contact@tonytunnel.xyz

:Done
timeout /t 10


cls
color 7
for /l %%i in (1, 1, 1) do (
  echo   ______                     ______                       __
  echo  /_  __/___  ____  __  __   /_  __/_  ______  ____  ___  / /
  echo   / / / __ \/ __ \/ / / /    / / / / / / __ \/ __ \/ _ \/ / 
  echo  / / / /_/ / / / / /_/ /    / / / /_/ / / / / / / /  __/ /  
  echo /_/  \____/_/ /_/\__, /    /_/  \__,_/_/ /_/_/ /_/\___/_/   
  echo                 /____/                                    
  echo Shutting Down ARC Reactor [#######################################]
  timeout /t 1 >nul
  cls
  echo   ______                     ______                       __
  echo  /_  __/___  ____  __  __   /_  __/_  ______  ____  ___  / /
  echo   / / / __ \/ __ \/ / / /    / / / / / / __ \/ __ \/ _ \/ / 
  echo  / / / /_/ / / / / /_/ /    / / / /_/ / / / / / / /  __/ /  
  echo /_/  \____/_/ /_/\__, /    /_/  \__,_/_/ /_/_/ /_/\___/_/   
  echo                 /____/                                    
  echo Shutting Down ARC Reactor [#################################      ]
  timeout /t 1 >nul
  cls
  echo   ______                     ______                       __
  echo  /_  __/___  ____  __  __   /_  __/_  ______  ____  ___  / /
  echo   / / / __ \/ __ \/ / / /    / / / / / / __ \/ __ \/ _ \/ / 
  echo  / / / /_/ / / / / /_/ /    / / / /_/ / / / / / / /  __/ /  
  echo /_/  \____/_/ /_/\__, /    /_/  \__,_/_/ /_/_/ /_/\___/_/   
  echo                 /____/                                    
  echo Shutting Down ARC Reactor [############################           ] 
  timeout /t 1 >nul
  cls
  echo   ______                     ______                       __
  echo  /_  __/___  ____  __  __   /_  __/_  ______  ____  ___  / /
  echo   / / / __ \/ __ \/ / / /    / / / / / / __ \/ __ \/ _ \/ / 
  echo  / / / /_/ / / / / /_/ /    / / / /_/ / / / / / / /  __/ /  
  echo /_/  \____/_/ /_/\__, /    /_/  \__,_/_/ /_/_/ /_/\___/_/   
  echo                 /____/                                    
  echo Shutting Down ARC Reactor [#####################                  ] 
  timeout /t 1 >nul
  cls
  echo   ______                     ______                       __
  echo  /_  __/___  ____  __  __   /_  __/_  ______  ____  ___  / /
  echo   / / / __ \/ __ \/ / / /    / / / / / / __ \/ __ \/ _ \/ / 
  echo  / / / /_/ / / / / /_/ /    / / / /_/ / / / / / / /  __/ /  
  echo /_/  \____/_/ /_/\__, /    /_/  \__,_/_/ /_/_/ /_/\___/_/   
  echo                 /____/                                    
  echo Shutting Down ARC Reactor [############                           ] 
  timeout /t 1 >nul
  cls
  echo   ______                     ______                       __
  echo  /_  __/___  ____  __  __   /_  __/_  ______  ____  ___  / /
  echo   / / / __ \/ __ \/ / / /    / / / / / / __ \/ __ \/ _ \/ / 
  echo  / / / /_/ / / / / /_/ /    / / / /_/ / / / / / / /  __/ /  
  echo /_/  \____/_/ /_/\__, /    /_/  \__,_/_/ /_/_/ /_/\___/_/   
  echo                 /____/                                    
  echo Shutting Down ARC Reactor [#########                              ] 
  timeout /t 1 >nul
  cls
  echo   ______                     ______                       __
  echo  /_  __/___  ____  __  __   /_  __/_  ______  ____  ___  / /
  echo   / / / __ \/ __ \/ / / /    / / / / / / __ \/ __ \/ _ \/ / 
  echo  / / / /_/ / / / / /_/ /    / / / /_/ / / / / / / /  __/ /  
  echo /_/  \____/_/ /_/\__, /    /_/  \__,_/_/ /_/_/ /_/\___/_/   
  echo                 /____/                                    
  echo Shutting Down ARC Reactor [#                                      ] 
  timeout /t 1 >nul
  cls
  echo   ______                     ______                       __
  echo  /_  __/___  ____  __  __   /_  __/_  ______  ____  ___  / /
  echo   / / / __ \/ __ \/ / / /    / / / / / / __ \/ __ \/ _ \/ / 
  echo  / / / /_/ / / / / /_/ /    / / / /_/ / / / / / / /  __/ /  
  echo /_/  \____/_/ /_/\__, /    /_/  \__,_/_/ /_/_/ /_/\___/_/   
  echo                 /____/                                    
  echo Shutting Down ARC Reactor [                                       ]
  timeout /t 1 >nul
  echo ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  echo                    Powered DOWN ARC Reactor !!
  echo                      Shutting Down System
  echo                    [https://tonytunnel.xyz]
  echo ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
)
timeout /t 4 >nul

goto :eof
